<!-- üè¶ Dashboard Header -->
<h2 class="text-center mb-4">Financial Dashboard</h2>

<!-- üìÖ Month Navigation -->
<div class="text-center mb-4">
    <button (click)="changeMonth(-1)" class="btn btn-outline-primary btn-sm">‚óÄ Prev</button>

    <input type="month" [(ngModel)]="selectedMonth" (ngModelChange)="loadMonthData()"
        class="mx-2 form-control d-inline-block" style="width: 180px" />

    <button (click)="changeMonth(1)" class="btn btn-outline-primary btn-sm">Next ‚ñ∂</button>
</div>

<!-- üîÅ Auto Refresh Info -->
<div class="dashboard-header text-center position-relative mb-4">
    <div class="auto-refresh-counter">
        üîÑ {{ autoHitCount }}
            <button (click)="refresh()" class="">Refresh</button>
        <small *ngIf="lastRefreshedAt">({{ lastRefreshedAt | date: 'shortTime' }})</small>
    </div>
</div>

<!-- üìä Summary -->
<div class="summary text-center mb-4 d-flex justify-content-center flex-wrap gap-3 align-items-center">
    <div class="metric-badge">Total Transactions: <strong>{{ totalTransactions }}</strong></div>
    <div class="metric-badge">
        Total Amount: <strong>{{ totalAmount | currency: 'INR':'symbol':'1.0-0' }}</strong>
    </div>
    <div class="metric-badge">Avg. Daily Spend: ‚Çπ{{ avgDailySpend | number: '1.0-0' }}</div>
    <div class="metric-badge" *ngIf="highestSpendDay">
        Highest Spend: ‚Çπ{{ highestSpendDay.amount }} on {{ highestSpendDay.date }}
    </div>

    <a routerLink="/top-payees" class="metric-badge metric-badge-link" title="View Top Payees">
        Top Payees
    </a>
</div>

<!-- üìà Line Chart + Hover Table -->
<div class="chart-container position-relative" *ngIf="lineDailyData?.labels?.length"
    (mouseleave)="onChartLeave()"
>
    <h4>Daily Spending</h4>

    <canvas baseChart [data]="lineDailyData" [type]="lineChartType" [options]="lineChartOptions"
        (chartHover)="onLineHover($event)" class="chart-canvas"></canvas>

    <!-- üí¨ Hover Transactions Table -->
    <div class="hover-table-container shadow-lg" *ngIf="isTableVisible && hoveredTransactions.length"
        (click)="toggleTablePin()" [class.pinned]="isTablePinned">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
<div class="d-flex align-items-center gap-2 flex-wrap">
    <button class="btn btn-sm btn-outline-primary" (click)="changeDay(-1); $event.stopPropagation()">‚óÄ</button>

    <input type="date" [value]="hoveredDate" (change)="onDateInputChange($event); $event.stopPropagation()"
        class="form-control form-control-sm" style="width: 160px;" />

    <button class="btn btn-sm btn-outline-primary" (click)="changeDay(1); $event.stopPropagation()">‚ñ∂</button>

    <small class="text-muted ms-2">(DEBIT only)</small>
</div>


            <div>
                <button *ngIf="hiddenTransactionIds.size > 0" class="btn btn-sm btn-outline-secondary me-2"
                    (click)="clearHiddenTransactions(); $event.stopPropagation()">
                    ‚ôªÔ∏è Show Hidden ({{ hiddenTransactionIds.size }})
                </button>

                <button class="btn btn-sm btn-outline-secondary" (click)="exportCSV(); $event.stopPropagation()">
                    <i class="bi bi-download"></i> Export CSV
                </button>
            </div>
        </div>

        <!-- Search -->
        <input type="text" [(ngModel)]="searchText" (ngModelChange)="filterTransactions()"
            placeholder="üîç Search Payee / UPI" class="form-control mb-3 shadow-sm"
            (click)="$event.stopPropagation()" />

<div class="table-responsive rounded shadow-sm" (click)="$event.stopPropagation()">
    <table class="table table-hover align-middle mb-0">
        <thead class="table-primary sticky-top">
            <tr>
                <th>Payee</th>
                <th class="text-end">Amount (‚Çπ)</th>
                <th>UPI</th>
                <th>Time</th>
                <th class="text-center">Action</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let t of filteredTransactions" [class.table-warning]="t.amount > 10000"
                [class.opacity-50]="hiddenTransactionIds.has(t.id)">
                <td><strong>{{ t.payeeName }}</strong></td>
                <td class="text-end text-success fw-semibold">
                    {{ t.amount | currency: 'INR':'symbol':'1.0-0' }}
                </td>
                <td><code class="text-muted">{{ t.toUpi }}</code></td>
                <td>{{ t.emailReceivedDate | date: 'shortTime' }}</td>
                <td class="text-center">
                    <button class="btn btn-sm" [ngClass]="{
              'btn-outline-danger': !hiddenTransactionIds.has(t.id),
              'btn-outline-success': hiddenTransactionIds.has(t.id)
            }" (click)="
              hiddenTransactionIds.has(t.id)
                ? hiddenTransactionIds.delete(t.id)
                : hideTransaction(t, $event)
            " title="Hide / Unhide transaction">
                        <i [class.bi-eye-slash]="!hiddenTransactionIds.has(t.id)"
                            [class.bi-eye]="hiddenTransactionIds.has(t.id)"></i>
                    </button>
                </td>
            </tr>
        </tbody>
    </table>
</div>


        <!-- Footer -->
        <small class="text-muted d-block mt-3">
            üí° Hover on the chart to view transactions for that date.
            <span *ngIf="!isTablePinned">Click to pin.</span>
            <span *ngIf="isTablePinned">Click again to unpin.</span>
        </small>
    </div>
</div>