<!-- ðŸ¦ Dashboard Header -->
<h2 class="text-center mb-4">Financial Dashboard</h2>

<!-- ðŸ“… Month Navigation -->
<div class="text-center mb-4">
    <button (click)="changeMonth(-1)" class="btn btn-outline-primary btn-sm">â—€ Prev</button>

    <input type="month" [(ngModel)]="selectedMonth" (ngModelChange)="loadMonthData()"
        class="mx-2 form-control d-inline-block" style="width: 180px" />

    <button (click)="changeMonth(1)" class="btn btn-outline-primary btn-sm">Next â–¶</button>
</div>

<!-- ðŸ” Auto Refresh Info -->
<div class="dashboard-header text-center position-relative mb-4">
    <div class="auto-refresh-counter">
        ðŸ”„ {{ autoHitCount }}
        <small *ngIf="lastRefreshedAt">({{ lastRefreshedAt | date: 'shortTime' }})</small>
    </div>
</div>

<!-- ðŸ“Š Summary (All Inline + Top Payees as Badge) -->
<div class="summary text-center mb-4 d-flex justify-content-center flex-wrap gap-3 align-items-center">
    <div class="metric-badge">Total Transactions: <strong>{{ totalTransactions }}</strong></div>
    <div class="metric-badge">
        Total Amount: <strong>{{ totalAmount | currency: 'INR':'symbol':'1.0-0' }}</strong>
    </div>
    <div class="metric-badge">Avg. Daily Spend: â‚¹{{ avgDailySpend | number: '1.0-0' }}</div>
    <div class="metric-badge" *ngIf="highestSpendDay">
        Highest Spend: â‚¹{{ highestSpendDay.amount }} on {{ highestSpendDay.date }}
    </div>
    <a routerLink="/top-payees" class="metric-badge metric-badge-link" title="View Top Payees">
        Top Payees
    </a>
</div>

<!-- ðŸ“ˆ Line Chart + Hover Table -->
<div class="chart-container position-relative" *ngIf="lineDailyData?.labels?.length"
    (mouseenter)="!isTablePinned && (isTableVisible = true)" (mouseleave)="!isTablePinned && (isTableVisible = false)">
    <h4>Daily Spending</h4>

    <canvas baseChart [data]="lineDailyData" [type]="lineChartType" [options]="lineChartOptions"
        (chartHover)="onLineHover($event)" class="chart-canvas"></canvas>

    <!-- ðŸ’¬ Hover Transactions Table -->
    <div class="hover-table-container shadow-lg" *ngIf="isTableVisible && hoveredTransactions.length"
        (click)="toggleTablePin()" [class.pinned]="isTablePinned">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="m-0">
                Transactions for <strong>{{ hoveredDate }}</strong>
                <small class="text-muted ms-2">(DEBIT only)</small>
            </h5>

            <button class="btn btn-sm btn-outline-secondary" (click)="exportCSV(); $event.stopPropagation()">
                <i class="bi bi-download"></i> Export CSV
            </button>
        </div>

        <!-- Search -->
        <input type="text" [(ngModel)]="searchText" (ngModelChange)="filterTransactions()"
            placeholder="ðŸ” Search Payee / UPI" class="form-control mb-3 shadow-sm"
            (click)="$event.stopPropagation()" />

        <!-- Table -->
        <div class="table-responsive rounded shadow-sm" (click)="$event.stopPropagation()">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-primary sticky-top">
                    <tr>
                        <th>Payee</th>
                        <th class="text-end">Amount (â‚¹)</th>
                        <th>UPI</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let t of filteredTransactions" [class.table-warning]="t.amount > 1000">
                        <td><strong>{{ t.payeeName }}</strong></td>
                        <td class="text-end text-success fw-semibold">
                            {{ t.amount | currency: 'INR':'symbol':'1.0-0' }}
                        </td>
                        <td><code class="text-muted">{{ t.toUpi }}</code></td>
                        <td>{{ t.emailReceivedDate | date: 'shortTime' }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Footer -->
        <small class="text-muted d-block mt-3">
            ðŸ’¡ Hover on the chart to view transactions for that date.
            <span *ngIf="!isTablePinned">Click to pin.</span>
            <span *ngIf="isTablePinned">Click again to unpin.</span>
        </small>
    </div>
</div>